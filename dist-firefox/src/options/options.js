const B=typeof browser<"u"?browser:chrome;async function T(n){return console.log("Background bridge sending message:",n),new Promise((t,b)=>{B.runtime.sendMessage(n,u=>{console.log("Background bridge received response:",u),B.runtime.lastError?(console.error("Background bridge error:",B.runtime.lastError),b(new Error(B.runtime.lastError.message))):t(u)})})}async function Q(){const n=await T({type:"GET_SETTINGS"});if(!n.success)throw new Error(n.error||"Failed to get settings");return n.data}async function S(n){const t=await T({type:"PUT_SETTINGS",data:n});if(!t.success)throw new Error(t.error||"Failed to save settings")}async function H(){const n=await T({type:"GET_ALL_CONTACTS"});if(!n.success)throw new Error(n.error||"Failed to get contacts");return n.data}async function Z(){const n=await T({type:"GET_ALL_EVENTS"});if(!n.success)throw new Error(n.error||"Failed to get events");return n.data}async function ee(){const n=await T({type:"CLEAR_ALL_CONTACTS"});if(!n.success)throw new Error(n.error||"Failed to clear contacts")}async function ne(){const n=await T({type:"CLEAR_ALL_EVENTS"});if(!n.success)throw new Error(n.error||"Failed to clear events")}async function te(n){const t=await T({type:"IMPORT_CONTACTS",data:n});if(!t.success)throw new Error(t.error||"Failed to import contacts")}async function re(n){const t=await T({type:"IMPORT_EVENTS",data:n});if(!t.success)throw new Error(t.error||"Failed to import events")}async function oe(){const n=await T({type:"EXPORT_DATA"});if(!n.success)throw new Error(n.error||"Failed to export data");return n.data}const j=typeof browser<"u"?browser:chrome;function e(n,t={},...b){const u=document.createElement(n);return Object.assign(u,t),b.forEach(L=>u.append(L)),u}async function J(){try{return await H(),!0}catch(n){return console.log("LinkedIn not available:",n),!1}}function ie(n){n.innerHTML="";const t=e("div",{className:"linkedin-message",style:`
      text-align: center;
      padding: 60px 20px;
      max-width: 500px;
      margin: 0 auto;
    `}),b=e("div",{innerHTML:"🔗",style:`
      font-size: 64px;
      margin-bottom: 24px;
    `}),u=e("h1",{innerText:"LinkedIn Verbindung erforderlich",style:`
      color: #333;
      margin-bottom: 16px;
      font-size: 24px;
    `}),L=e("p",{innerText:"Um auf Ihre Connection Manager Daten zuzugreifen, muss LinkedIn in einem Tab geöffnet sein.",style:`
      color: #666;
      margin-bottom: 32px;
      line-height: 1.5;
      font-size: 16px;
    `}),o=e("button",{innerText:"LinkedIn öffnen",style:`
      background: #0073b1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      margin-right: 12px;
      transition: background-color 0.2s;
    `}),v=e("button",{innerText:"Seite aktualisieren",style:`
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: background-color 0.2s;
    `}),g=e("div",{innerText:"Überprüfe Verbindung...",style:`
      margin-top: 24px;
      color: #666;
      font-size: 14px;
    `});o.onmouseenter=()=>{o.style.backgroundColor="#005a8b"},o.onmouseleave=()=>{o.style.backgroundColor="#0073b1"},v.onmouseenter=()=>{v.style.backgroundColor="#218838"},v.onmouseleave=()=>{v.style.backgroundColor="#28a745"},o.addEventListener("click",()=>{window.open("https://www.linkedin.com","_blank")}),v.addEventListener("click",()=>{window.location.reload()}),t.append(b,u,L,o,v,g),n.appendChild(t);let E,y=0;const k=60,h=async()=>{if(y++,await J()){clearInterval(E),g.innerText="✅ Verbindung hergestellt! Lade Seite neu...",setTimeout(()=>window.location.reload(),1e3);return}if(y>=k){clearInterval(E),g.innerText="⏰ Automatische Überprüfung beendet. Klicken Sie 'Seite aktualisieren' um manuell zu prüfen.";return}g.innerText=`Überprüfe Verbindung... (${y}/${k})`};E=window.setInterval(h,5e3),h()}const q=["#28a745","#007bff","#ffc107","#dc3545","#6f42c1","#fd7e14","#20c997","#e83e8c","#6c757d","#17a2b8"],ae=["💼","👥","🤝","❤️","⭐","🔥","💡","🎯","🚀","💎","🌟","🎉","🏆","💪","🎨","📚","💻","🎵","🏠","🌍","👨‍💼","👩‍💼","👨‍🎓","👩‍🎓","👨‍🔬","👩‍🔬","👨‍⚕️","👩‍⚕️","👨‍🏫","👩‍🏫","👨‍💻","👩‍💻","👨‍🎨","👩‍🎨","👨‍🚀","👩‍🚀","👨‍⚖️","👩‍⚖️","👨‍🌾","👩‍🌾"];function se(n,t){const b=e("div",{className:"section"}),u=e("h2",{innerText:"Kategorien verwalten"}),L=e("div",{className:"help-text",innerText:"Erstellen Sie eigene Kategorien oder bearbeiten Sie die Standard-Kategorien. Jede Kategorie benötigt einen Namen in Deutsch und Englisch, ein Emoticon und eine Farbe."}),o=e("div",{className:"categories-container"});function v(r,w){const p=e("div",{className:"category-item"}),i=e("span",{innerText:r.emoticon,style:"font-size: 24px; margin-right: 8px;"}),a=e("div",{style:`width: 20px; height: 20px; background-color: ${r.color}; border-radius: 50%; margin-right: 8px; border: 2px solid #ddd;`}),l=e("div",{className:"category-labels"}),d=e("div",{innerText:`${r.label_de} (${r.value} Punkte)`,style:"font-weight: bold;"}),s=e("div",{innerText:r.label_en,style:"font-size: 12px; color: #666;"});l.append(d,s);const c=e("div",{className:"category-actions"}),m=e("button",{innerText:"Bearbeiten",className:"edit-btn",style:"margin-right: 8px; padding: 4px 8px; font-size: 12px;"}),N=e("button",{innerText:"Löschen",className:"delete-btn",style:"padding: 4px 8px; font-size: 12px; background-color: #dc3545;"});return["business","colleague","acquaintance"].includes(r.id)&&(N.disabled=!0,N.style.opacity="0.5",N.title="Standard-Kategorien können nicht gelöscht werden"),c.append(m,N),p.append(i,a,l,c),m.addEventListener("click",()=>{E(r,w,!0)}),N.addEventListener("click",async()=>{if(confirm(`Möchten Sie die Kategorie "${r.label_de}" wirklich löschen?`)){n.categories.splice(w,1),await S(n),g();const I=e("div",{className:"success",innerText:`Kategorie "${r.label_de}" wurde gelöscht.`});t.appendChild(I),setTimeout(()=>{t.contains(I)&&t.removeChild(I)},3e3)}}),p}function g(){o.innerHTML="",n.categories.forEach((r,w)=>{o.appendChild(v(r,w))})}function E(r=null,w=-1,p=!1){const i=document.createElement("div");i.className="dialog-overlay",i.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    `;const a=document.createElement("div");a.className="dialog",a.style.cssText=`
      background: white;
      padding: 24px;
      border-radius: 8px;
      min-width: 400px;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    `;const l=e("h3",{innerText:p?"Kategorie bearbeiten":"Neue Kategorie erstellen"}),d=e("div",{className:"category-form"}),s=e("div",{className:"form-group"}),c=e("label",{innerText:"Name (Deutsch):"}),m=e("input",{type:"text",value:(r==null?void 0:r.label_de)||"",placeholder:"z.B. Geschäftsbeziehung",style:"width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;"});s.append(c,m);const N=e("div",{className:"form-group"}),I=e("label",{innerText:"Name (English):"}),K=e("input",{type:"text",value:(r==null?void 0:r.label_en)||"",placeholder:"e.g. Business relationship",style:"width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;"});N.append(I,K);const F=e("div",{className:"form-group"}),Y=e("label",{innerText:"Punkte (0-100):"}),$=e("input",{type:"number",min:"0",max:"100",value:(r==null?void 0:r.value)||50,style:"width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;"});F.append(Y,$);const G=e("div",{className:"form-group"}),W=e("label",{innerText:"Emoticon:"}),D=e("div",{style:"display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; margin-top: 8px; max-height: 120px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 8px;"});let _=(r==null?void 0:r.emoticon)||"💼";ae.forEach(x=>{const f=e("button",{innerText:x,style:`
          font-size: 20px;
          padding: 8px;
          border: 2px solid ${x===_?"#007bff":"#ddd"};
          background: ${x===_?"#e3f2fd":"white"};
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.2s;
        `});f.addEventListener("click",()=>{_=x,D.querySelectorAll("button").forEach(C=>{C.style.borderColor="#ddd",C.style.background="white"}),f.style.borderColor="#007bff",f.style.background="#e3f2fd"}),D.appendChild(f)}),G.append(W,D);const O=e("div",{className:"form-group"}),X=e("label",{innerText:"Farbe:"}),A=e("div",{style:"display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px;"});let M=(r==null?void 0:r.color)||q[0];q.forEach(x=>{const f=e("button",{style:`
          width: 40px;
          height: 40px;
          border: 3px solid ${x===M?"#333":"#ddd"};
          background-color: ${x};
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.2s;
        `});f.addEventListener("click",()=>{M=x,A.querySelectorAll("button").forEach(C=>{C.style.borderColor="#ddd"}),f.style.borderColor="#333"}),A.appendChild(f)}),O.append(X,A);const R=e("div",{style:"display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;"}),U=e("button",{innerText:"Abbrechen",style:"padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;"}),V=e("button",{innerText:p?"Aktualisieren":"Erstellen",style:"padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;"});R.append(U,V),U.addEventListener("click",()=>{document.body.removeChild(i)}),V.addEventListener("click",async()=>{const x=m.value.trim(),f=K.value.trim(),C=parseInt($.value);if(!x||!f){alert("Bitte füllen Sie alle Felder aus.");return}if(C<0||C>100){alert("Punkte müssen zwischen 0 und 100 liegen.");return}const P={id:(r==null?void 0:r.id)||`custom_${Date.now()}`,label_de:x,label_en:f,value:C,color:M,emoticon:_};p?n.categories[w]=P:n.categories.push(P),await S(n),g();const z=e("div",{className:"success",innerText:p?"Kategorie wurde aktualisiert.":"Neue Kategorie wurde erstellt."});t.appendChild(z),setTimeout(()=>{t.contains(z)&&t.removeChild(z)},3e3),document.body.removeChild(i)}),d.append(s,N,F,G,O),a.append(l,d,R),i.appendChild(a),document.body.appendChild(i)}const y=e("button",{innerText:"Neue Kategorie hinzufügen",style:"margin-bottom: 16px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;"}),k=e("button",{innerText:"Standard-Kategorien wiederherstellen",style:"margin-bottom: 16px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;"}),h=e("div",{style:"margin-bottom: 16px;"});return y.addEventListener("click",()=>{E()}),k.addEventListener("click",async()=>{if(confirm("Möchten Sie wirklich alle Kategorien auf die Standard-Kategorien zurücksetzen? Dies kann nicht rückgängig gemacht werden.")){n.categories=[{id:"business",label_de:"Geschäftsbeziehung",label_en:"Business relationship",value:80,color:"#28a745",emoticon:"💼"},{id:"colleague",label_de:"Kollege",label_en:"Colleague",value:60,color:"#007bff",emoticon:"👥"},{id:"acquaintance",label_de:"Bekanntschaft",label_en:"Acquaintance",value:40,color:"#ffc107",emoticon:"🤝"}],await S(n),g();const r=e("div",{className:"success",innerText:"Kategorien wurden auf Standard-Kategorien zurückgesetzt."});t.appendChild(r),setTimeout(()=>{t.contains(r)&&t.removeChild(r)},3e3)}}),h.append(y,k),g(),b.append(u,L,h,o),b}async function ce(n){const t=await Q(),b=e("h1",{innerText:"Connection Manager Einstellungen"}),u=e("div",{className:"section"},e("h2",{innerText:"Gewichte"}),e("div",{className:"form-group"},e("div",{className:"input-row"},e("label",{innerText:"Kategorien"}),e("input",{type:"number",step:"0.01",value:t.weights.categories,id:"w_cat"})),e("div",{className:"help-text"},"Gewichtung für Kategoriebewertung (0-1)")),e("div",{className:"form-group"},e("div",{className:"input-row"},e("label",{innerText:"Events"}),e("input",{type:"number",step:"0.01",value:t.weights.events,id:"w_evt"})),e("div",{className:"help-text"},"Gewichtung für Interaktionsbewertung (0-1)")),e("div",{className:"form-group"},e("div",{className:"input-row"},e("label",{innerText:"Empfinden"}),e("input",{type:"number",step:"0.01",value:t.weights.affinity,id:"w_aff"})),e("div",{className:"help-text"},"Gewichtung für persönliches Empfinden (0-1)"))),L=e("div",{className:"section"},e("h2",{innerText:"Verfall"}),e("div",{className:"form-group"},e("div",{className:"input-row"},e("label",{innerText:"Start (Tage)"}),e("input",{type:"number",value:t.decay.decayStartDays,id:"d_start"})),e("div",{className:"help-text"},"Nach wie vielen Tagen beginnt der Verfall")),e("div",{className:"form-group"},e("div",{className:"input-row"},e("label",{innerText:"Halbwert (Tage)"}),e("input",{type:"number",value:t.decay.halfLifeDays,id:"d_half"})),e("div",{className:"help-text"},"Nach wie vielen Tagen halbiert sich der Wert")),e("div",{className:"form-group"},e("label",{innerText:"Modus"}),(()=>{const i=e("select",{id:"d_mode"});return["exponential","linear","off"].forEach(a=>i.append(e("option",{value:a,innerText:a,selected:t.decay.mode===a}))),i})(),e("div",{className:"help-text"},"Art des Verfalls: exponential, linear oder aus"))),o=e("div",{id:"message-container"}),v=se(t,o),g=e("div",{className:"section"},e("h2",{innerText:"Daten Export/Import"}),e("div",{className:"form-group"},e("div",{className:"button-row"},e("button",{innerText:"Daten exportieren",id:"export-btn",className:"export-btn"}),e("button",{innerText:"Daten importieren",id:"import-btn",className:"import-btn"}),e("button",{innerText:"DB Test",id:"db-test-btn",className:"db-test-btn"})),e("div",{className:"help-text"},"Exportieren Sie alle Daten als JSON-Datei oder importieren Sie eine zuvor exportierte Datei"))),E=e("div",{className:"section"},e("h2",{innerText:"Datenschutz"}),e("div",{className:"form-group"},e("div",{className:"checkbox-row"},e("input",{type:"checkbox",id:"anonymous-mode",checked:t.anonymousMode}),e("label",{innerText:"Anonymus Modus",htmlFor:"anonymous-mode"})),e("div",{className:"help-text"},"Überdeckt alle Namen auf LinkedIn mit einem geblurten schwarzen Balken"))),y=e("div",{className:"button-container"}),k=e("button",{innerText:"Speichern"});k.addEventListener("click",async()=>{const i=parseFloat(document.getElementById("w_cat").value),a=parseFloat(document.getElementById("w_evt").value),l=parseFloat(document.getElementById("w_aff").value),d=i+a+l;if(o.innerHTML="",Math.abs(d-1)>1e-4){const s=e("div",{className:"error",innerText:`Summe der Gewichte muss 1 sein. Aktuell: ${d.toFixed(2)}`});o.appendChild(s);return}try{t.weights={categories:i,events:a,affinity:l},t.decay={mode:document.getElementById("d_mode").value,decayStartDays:parseInt(document.getElementById("d_start").value,10),halfLifeDays:parseInt(document.getElementById("d_half").value,10)},t.anonymousMode=document.getElementById("anonymous-mode").checked,await S(t);try{(await j.tabs.query({url:"https://*.linkedin.com/*"})).forEach(m=>{m.id&&j.tabs.sendMessage(m.id,{type:"SETTINGS_UPDATED"})})}catch(c){console.log("Could not notify content script:",c)}const s=e("div",{className:"success",innerText:"Einstellungen erfolgreich gespeichert!"});o.appendChild(s),setTimeout(()=>{o.contains(s)&&o.removeChild(s)},3e3)}catch{const c=e("div",{className:"error",innerText:"Fehler beim Speichern der Einstellungen"});o.appendChild(c)}}),y.appendChild(k),n.append(b,u,L,v,g,E,o,y);const h=document.getElementById("export-btn");h.addEventListener("click",async()=>{try{h.disabled=!0,h.innerText="Exportiere...",console.log("Starting export via background script...");const i=await oe();console.log("Export data:",i);const a=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),l=URL.createObjectURL(a),d=document.createElement("a");d.href=l,d.download=`linkedin-connections-export-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(l);const s=e("div",{className:"success",innerText:`Export erfolgreich! ${i.contacts.length} Kontakte und ${i.events.length} Events exportiert.`});o.appendChild(s),setTimeout(()=>{o.contains(s)&&o.removeChild(s)},5e3)}catch(i){console.error("Export error:",i);const a=e("div",{className:"error",innerText:"Fehler beim Exportieren der Daten"});o.appendChild(a)}finally{h.disabled=!1,h.innerText="Daten exportieren"}});const r=document.getElementById("import-btn"),w=e("input",{type:"file",accept:".json",style:"display: none",id:"file-input"});document.body.appendChild(w),r.addEventListener("click",()=>{w.click()}),w.addEventListener("change",async i=>{var d;const a=i.target,l=(d=a.files)==null?void 0:d[0];if(l)try{r.disabled=!0,r.innerText="Importiere...";const s=await l.text(),c=JSON.parse(s);if(c.version!=="1.0")throw new Error("Unsupported export version");if(await ee(),await ne(),await te(c.contacts),await re(c.events),c.settings){await S(c.settings),window.location.reload();return}const m=e("div",{className:"success",innerText:`Import erfolgreich! ${c.contacts.length} Kontakte und ${c.events.length} Events importiert.`});o.appendChild(m),setTimeout(()=>{o.contains(m)&&o.removeChild(m)},5e3)}catch(s){const c=e("div",{className:"error",innerText:`Fehler beim Importieren: ${s instanceof Error?s.message:"Unbekannter Fehler"}`});o.appendChild(c)}finally{r.disabled=!1,r.innerText="Daten importieren",a.value=""}});const p=document.getElementById("db-test-btn");p.addEventListener("click",async()=>{try{p.disabled=!0,p.innerText="Teste...",console.log("=== DATABASE TEST VIA BACKGROUND SCRIPT ===");const i=await H(),a=await Z();console.log("Contacts via background script:",i),console.log("Events via background script:",a);const l=e("div",{className:"success",innerText:`DB Test: ${i.length} Kontakte, ${a.length} Events gefunden. Siehe Konsole für Details.`});o.appendChild(l),setTimeout(()=>{o.contains(l)&&o.removeChild(l)},1e4)}catch(i){console.error("DB Test error:",i);const a=e("div",{className:"error",innerText:`DB Test Fehler: ${i instanceof Error?i.message:"Unbekannter Fehler"}`});o.appendChild(a)}finally{p.disabled=!1,p.innerText="DB Test"}})}(async function(){const t=document.getElementById("app");await J()?await ce(t):ie(t)})();
